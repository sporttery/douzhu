var http=require("http"),url=require("url"),util=require("util");const fs=require("fs"),md5=require("md5-node"),{readSettings:readSettings,saveSettings:saveSettings}=require("./config"),path=require("path"),{default:axios}=require("axios"),port=8888;Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var k in/(y+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),o)new RegExp("("+k+")").test(fmt)&&(fmt=fmt.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return fmt};const requestType={".css":"text/css",".js":"text/javascript",".html":"text/html",".png":"image/png",".gif":"image/gif",".svg":"image/svg+xml",".woff2":"font/woff2",".woff":"font/woff",".ttf":"font/ttf",".eot":"font/eot"},api_host="http://47.97.98.67",default_code="b0366f4efb7f4c5c",dataMap=readSettings("dataMap")||{},loginInfo=readSettings("loginInfo"),secretKey="5645asdfWEREWRsdfaC>Vb#$%43asd3256&*!",accessToken=md5(loginInfo.pwd+loginInfo.user+secretKey),tokenKey="__token",pagesize=30,expires=18e5;function getCookie(req,name){var cookieStr=req.headers.cookie;if(cookieStr)for(var cookies=cookieStr.split(/[=;]/),i=0;i<cookies.length;i++)if(cookies[i]==name)return cookies[i+1];return null}function delCookie(res,name){setCookie(res,name,"",-1)}const cookieExpires=n=>{const d=new Date;return n||(n=0),d.setTime(d.getTime()+n),d.toGMTString()};function setCookie(res,name,value,expires){var cookieStr=name+"="+value+";path=/";expires&&(cookieStr+=";expires="+cookieExpires(expires)),res.setHeader("Set-Cookie",cookieStr)}var WebSocketServer=require("websocket").server,server=http.createServer((async function(req,res){let pathname=req.url.split(/[?]/)[0];pathname="/"==pathname?"/index.html":pathname;let ext=path.extname(pathname),query=url.parse(req.url,!0).query;if(console.log(pathname,query),pathname.startsWith("/api/")){res.writeHead(200,{"Content-Type":"application/json;charset=utf-8"});var data={code:0};if(-1!=pathname.indexOf("/api/verify"))if(query.code)if(query.version<"210")data=dataMap[query.code]&&"1"==dataMap[query.code].activeStatus?{code:0,data:{type:0,version:210,url:{apkUrl:"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/%E6%98%8A%E8%A7%86%E7%A7%91%E6%8A%80/210.apk"},content:"升级"},msg:"操作成功"}:{code:-1,msg:"版本太低，请下载最新版本"};else if(dataMap[query.code]){var info=dataMap[query.code];query.invite?info.invite==query.invite?"1"==info.activeStatus?data={code:-1,msg:"此设备已激活无需重复操作"}:(info.activeTime=(new Date).getTime(),saveSettings("dataMap",dataMap),data={code:-1,msg:"请等待审核后再激活设备"}):data={code:-1,msg:"无效的邀请码或使用已达上限"}:data="1"==info.activeStatus?info.deadline&&info.deadline<(new Date).getTime()?{code:-1,msg:"已过有效期,请联系管理员"}:{code:0,data:{nickName:info.invite,time:parseInt(info.deadline)/1e3,type:1},msg:"授权成功"}:info.invite?info.activeTime?{code:-1,msg:"请等待审核后再激活设备"}:{code:-1,msg:"请输入激活码激活设备"}:{code:-1,msg:"请先注册设备"}}else dataMap[query.code]=query,dataMap[query.code].regTime=(new Date).getTime(),saveSettings("dataMap",dataMap),data={code:-1,msg:"请先注册设备"};else data={code:-1,msg:"版本太低，请下载最新版本"};else if("/api/updateVersion"==pathname){var info;(info=dataMap[query.code])?"1"==info.activeStatus?data=info.deadline&&info.deadline<(new Date).getTime()?{code:-1,msg:"已过有效期,请联系管理员"}:"0"==query.type?query.oldVersion<"210"?{code:0,data:{type:0,version:210,url:{apkUrl:"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/%E6%98%8A%E8%A7%86%E7%A7%91%E6%8A%80/210.apk"},content:"升级"},msg:"操作成功"}:{code:-1,msg:"没有最新版本"}:"1"==query.type&&query.oldVersion<"10017"?{code:0,data:{type:1,version:10017,url:{"wz_en.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/wz_en.js","currency.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/currency.js","popcheck.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/popcheck.js","process.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/process.js","common.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/common.js","wz_ja.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/wz_ja.js","main.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/main.js","wz_es.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/wz_es.js","wz_zh_CN.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/wz_zh_CN.js","request.js":"https://dyver.oss-cn-beijing.aliyuncs.com/jgz/update/request.js"},content:"10017"},msg:"操作成功"}:{code:-1,msg:"没有最新版本"}:(data.code=-1,data.msg="设备未激活,请先激活"):(data.code=-1,data.msg="未找到code,版本过低,请先更新版本")}else if("/api/getTask"==pathname){var info;(info=dataMap[query.code])?"1"==info.activeStatus?data=info.deadline&&info.deadline<(new Date).getTime()?{code:-1,msg:"已过有效期,请联系管理员"}:{code:0,data:{activeCode:"b0366f4efb7f4c5c",content:'["武功秘籍"]',createTime:"2022-08-30 13:21:40",deviceId:51564,home:0,id:227879,state:1,taskParams:'[{"files":[{"identifier":"Secretjztc0One","name":"精准同城","url":"http://wangzha2.oss-cn-beijing.aliyuncs.com/%E7%B2%BE%E5%87%86%E5%90%8C%E5%9F%8E_Secretjztc0One.js?Expires=1975394694&OSSAccessKeyId=LTAIs0J8jCgUIYyT&Signature=Aj%2FhBPaZGmEvAi2hE0i6uLUD%2BjM%3D","fileType":8},{"identifier":"Secretkhbdtcplz0One","name":"同城评论赞","url":"http://wangzha2.oss-cn-beijing.aliyuncs.com/%E5%90%8C%E5%9F%8E%E8%AF%84%E8%AE%BA%E8%B5%9E_Secretkhbdtcplz0One.js?Expires=1975394702&OSSAccessKeyId=LTAIs0J8jCgUIYyT&Signature=VPVokgPWJkFmQxxvXRDMTu7orYI%3D","fileType":8},{"identifier":"Secretkhbdpr0One","name":"葵花宝典Pro","url":"http://wangzha2.oss-cn-beijing.aliyuncs.com/%E8%91%B5%E8%8A%B1%E5%AE%9D%E5%85%B8Pro_Secretkhbdpr0One.js?Expires=1975394701&OSSAccessKeyId=LTAIs0J8jCgUIYyT&Signature=RoCl2i9N%2FidtSZie80W4VJILWAQ%3D","fileType":8},{"identifier":"Secretkhbdp0One","name":"葵花宝典Plus","url":"http://wangzha2.oss-cn-beijing.aliyuncs.com/%E8%91%B5%E8%8A%B1%E5%AE%9D%E5%85%B8Plus_Secretkhbdp0One.js?Expires=1975394699&OSSAccessKeyId=LTAIs0J8jCgUIYyT&Signature=gK%2FgYXNzesvXO1UzhO%2BxTmAau8k%3D","fileType":8},{"identifier":"Secretkhbdm0One","name":"葵花宝典Max","url":"http://wangzha2.oss-cn-beijing.aliyuncs.com/%E8%91%B5%E8%8A%B1%E5%AE%9D%E5%85%B8Max_Secretkhbdm0One.js?Expires=1975394697&OSSAccessKeyId=LTAIs0J8jCgUIYyT&Signature=a057muqGTXNMJYzTY1oLTCDw1Hc%3D","fileType":8},{"identifier":"Secretkhbd0One","name":"葵花宝典","url":"http://wangzha2.oss-cn-beijing.aliyuncs.com/%E8%91%B5%E8%8A%B1%E5%AE%9D%E5%85%B8_Secretkhbd0One.js?Expires=1975394695&OSSAccessKeyId=LTAIs0J8jCgUIYyT&Signature=LKzOf6kveSweLATzaT%2B7cXgoqyg%3D","fileType":8}],"groupId":507215}]',type:10003,updateTime:"2022-08-30 13:21:40",userCode:"g17085878687"},msg:"操作成功"}:(data.code=-1,data.msg="设备未激活,请先激活"):(data.code=-1,data.msg="未找到code,版本过低,请先更新版本")}res.end(JSON.stringify(data))}else if(pathname.startsWith("/admin/")){var data={code:0},token;if(query.host==loginInfo.host&&query.password==loginInfo.pwd&&query.port==loginInfo.port&&query.user==loginInfo.user)data.msg="success",setCookie(res,tokenKey,accessToken,18e5);else if(getCookie(req,tokenKey)!=accessToken)data.code=-2,data.msg="密码错误";else if("/admin/userlist"==pathname)if(query.code)data.dataList=[dataMap[query.code]],date.totalCount=1;else{var arr=Object.values(dataMap).filter(v=>query.username?query.username==v.username:query.phoneNumber?query.phoneNumber==v.phoneNumber:query.begindateActive&&query.enddateActive?v.activeTime>=new Date(query.begindateActive).getTime()&&v.activeTime<=new Date(query.enddateActive).getTime()+864e5:query.begindateReg&&query.enddateReg?v.regTime>=new Date(query.begindateReg).getTime()&&v.regTime<=new Date(query.enddateReg).getTime()+864e5:""==query.activeStatus||query.activeStatus==v.activeStatus),sortBy=query.sortBy;sortBy||(sortBy="regTime"),arr.sort((a,b)=>{var flag=a[sortBy]==b[sortBy]?0:a[sortBy]>b[sortBy]?1:-1;return 0==flag?"regTime"==sortBy?a[sortBy="deadline"]==b[sortBy]?0:a[sortBy]>b[sortBy]?1:-1:a[sortBy="regTime"]==b[sortBy]?0:a[sortBy]>b[sortBy]?1:-1:flag}),data.totalCount=arr.length,query.currentPage?(currentPage=parseInt(query.currentPage),isNaN(currentPage)&&(currentPage=1)):currentPage=1,data.dataList=arr.slice(30*(currentPage-1),30*currentPage)}else if("/admin/saveInfo"==pathname){var code=query.code,info;(info=dataMap[code])?(info.invite=query.invite,info.deadline=query.deadline,info.username=query.username,info.phoneNumber=query.phoneNumber,info.activeStatus=query.activeStatus,saveSettings("dataMap",dataMap)):(data.code=-1,data.msg="序号"+code+"不存在")}res.setHeader("Content-Type","application/json;charset=utf-8"),res.end(JSON.stringify(data))}else fs.readFile("."+pathname,(err,data)=>{if(err)res.writeHead(404,{"Content-Type":'text/html;charset="utf-8"'}),res.end("<h3>404</h3>");else{if(-1!=pathname.indexOf("/login.html"))delCookie(res,tokenKey),res.setHeader("Content-Type",`${requestType[ext]};charset="utf-8"`);else{var token;if("/index.html"==pathname)return void(getCookie(req,tokenKey)!=accessToken?(res.writeHead(301,{Location:"/login.html"}),res.end()):(res.setHeader("Content-Type",`${requestType[ext]};charset="utf-8"`),res.end(data)));res.writeHead(200,{"Content-Type":`${requestType[ext]};charset="utf-8"`})}res.end(data)}})}));server.listen(8888),console.log("服务器开启成功，请打开localhost：8888");var server1=http.createServer();const wsServer=new WebSocketServer({httpServer:server1});wsServer.on("request",(function(request){var connection=request.accept(null,request.origin);connection.sendUTF("服务器发来消息说已经建立连接"),connection.on("message",(function(message){"utf8"===message.type?connection.sendUTF(message.utf8Data):"binary"===message.type&&connection.sendBytes(message.binaryData)})),connection.on("close",(function(reasonCode,description){console.log("连接关闭")}))})),server1.listen(8887),console.log("ws服务器开启成功，请打开localhost：8887");